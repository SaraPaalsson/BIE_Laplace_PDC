%% TIMINGS MPI - WEAK SCALING
close all; clear all; clc
%For Npanels 20, error approx 5e-8

%nbr_dompoints = 400000 * nbr_threads;
%nbr_panels = 20;

nbr_threads = [1; ...
               2; ...
               4; ...
               8; ...
               16; ...
               32];
               
time_sol = [1.998483; ...
            2.008524; ...
            2.184713+0.000399; ...
            2.500944+0.000347; ...
            2.568706+0.001395; ...
            2.568874+0.001454];
            
time_specq_loadimb = [0; ...
                1.737991; ...
                3.652075; ...
                5.357954; ...
                6.176538; ...
                7.049157];
            
time_main = [0; ...
            3.729813; ...
            8.622962; ...
            13.825290; ...
            16.927391; ...
            21.460105];
            
time_specqNoload = [1.902448; ...
                    1.943092; ...
                    2.071215; ...
                    2.417228; ...
                    2.518236; ...
                    2.553628];

time_tot = [4.474850; ...
            8.241826; ...
            13.694973; ...
            19.647783; ...
            23.040996; ...
            27.523940];


%%
figure(1); clf
loglog(nbr_threads,time_tot,'.-','LineWidth',2); 
hold on; grid on
loglog(nbr_threads,time_sol,'^-','LineWidth',2)
loglog(nbr_threads,time_specqNoload,'o-','LineWidth',2)
loglog(nbr_threads,time_main,'--','LineWidth',2);

xlabel('Number of MPI processes','FontSize',20,'interpreter','latex')
ylabel('time [s]','FontSize',20,'interpreter','latex')
set(gca,'FontSize',17)
h = legend('Total time','Comp. solution','Special quad.', ...
    'Main function');
set(h,'FontSize',17,'interpreter','latex')
title({'Timings for MPI code, weak scaling', '$N_{panels}=20$, $N_{dom}/thread=4\cdot 10^5$'},'FontSize',20,'interpreter','latex')
% loglog(nbr_dompoints,nbr_dompoints*1e-5,'k:','LineWidth',2)
% h = legend('Total time','Density comp.','Comp. solution','Special quad.','O(N)');


figure(3)
loglog(nbr_threads,time_specq_loadimb,'o-','LineWidth',2);
hold on; grid on
xlabel('Number of MPI processes','FontSize',20,'interpreter','latex')
ylabel('time [s]','FontSize',20,'interpreter','latex')
set(gca,'FontSize',17)
title({'Load imbalance time for specialquadlapl,','weak scaling'},'FontSize',20,'interpreter','latex')


%% Save info table cache 32 threads

func = {'total','compSol','specQuad','vandernewton','ipmultr'};

D1_hit = [99.9; ...
          100.0; ...
          99.5; ...
          99.7; ...
          99.5];
          
D1_miss = [0.1; ...
           0; ...
           0.5; ...
           0.3; ...
           0.5];

D2_hit = [74.6; ...
          100; ...
          78.4; ...
          70.6; ...
          72.1];

D2_miss = [25.4; ...
           0; ...
           21.6; ...
           29.4; ...
           27.9];

D1D2_hit = [100.0; ...
            100; ...
            99.9; ...
            99.9; ...
            99.9];
            
D1D2_miss = [0; ...
             0; ...
             0.1; ...
             0.1; ...
             0.1];


 table(D1_hit,D1_miss,D2_hit,D2_miss,D1D2_hit,D1D2_miss,'RowNames',func)
            